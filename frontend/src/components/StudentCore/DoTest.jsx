// const DoTest = () => {
//   return (
//     <div className="w-full h-full max-w-4xl mx-auto mt-8 bg-gray-100 px-10 py-5 font-nunito">
//       {/* Header */}
//       <div className="flex items-center justify-between mb-8">
//         <div>
//           <h1 className="text-2xl font-bold mb-4">
//             Bài thi môn <span>OOP</span>
//           </h1>
//         </div>
//         <div className="flex items-center justify-center">
//           <div className="text-blue-600 font-bold mr-12">
//             Thời gian: <span>40:00</span>
//           </div>
//           <div className="mr-6">
//             <button className="w-28 bg-blue-500 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition duration-300">
//               Nộp bài
//             </button>
//           </div>
//           <div>
//             <button className="w-28 bg-blue-500 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition duration-300">
//               Báo lỗi
//             </button>
//           </div>
//         </div>
//       </div>

//       {/* Nội dung bài thi */}
//       <div className="overflow-x-auto max-h-[500px] bg-white rounded-2xl">
//         <div className="px-12 py-6">
//           {/* Các câu hỏi và câu trả lời */}
//           <div className="mb-6">
//             <div>
//               <h2 className="font-semibold mb-4">
//                 <span>1</span>
//                 <span>. Hãy cho biết khái niệm OOP là gì?</span>
//               </h2>
//             </div>
//             <div>
//               <div className="mb-3 flex items-center">
//                 <input type="radio" name="id__answer--1" />
//                 <span className="ml-2">
//                   A. OOP là object oriented programming.
//                 </span>
//               </div>
//               <div className="mb-3 flex items-center">
//                 <input type="radio" name="id__answer--1" />
//                 <span className="ml-2">
//                   B. OOP là object oriented programming.
//                 </span>
//               </div>
//               <div className="mb-3 flex items-center">
//                 <input type="radio" name="id__answer--1" />
//                 <span className="ml-2">
//                   C. OOP là object oriented programming.
//                 </span>
//               </div>
//               <div className="mb-3 flex items-center">
//                 <input type="radio" name="id__answer--1" />
//                 <span className="ml-2">
//                   D. OOP là object oriented programming.
//                 </span>
//               </div>
//             </div>
//           </div>

//           <div className="mb-6">
//             <div>
//               <h2 className="font-semibold mb-4">
//                 <span>2</span>
//                 <span>. Hãy cho biết khái niệm OOP là gì?</span>
//               </h2>
//             </div>
//             <div>
//               <div className="mb-3 flex items-center">
//                 <input type="radio" name="id__answer--2" />
//                 <span className="ml-2">
//                   A. OOP là object oriented programming.
//                 </span>
//               </div>
//               <div className="mb-3 flex items-center">
//                 <input type="radio" name="id__answer--2" />
//                 <span className="ml-2">
//                   B. OOP là object oriented programming.
//                 </span>
//               </div>
//               <div className="mb-3 flex items-center">
//                 <input type="radio" name="id__answer--2" />
//                 <span className="ml-2">
//                   C. OOP là object oriented programming.
//                 </span>
//               </div>
//               <div className="mb-3 flex items-center">
//                 <input type="radio" name="id__answer--2" />
//                 <span className="ml-2">
//                   D. OOP là object oriented programming.
//                 </span>
//               </div>
//             </div>
//           </div>

//           <div className="mb-6">
//             <div>
//               <h2 className="font-semibold mb-4">
//                 <span>3</span>
//                 <span>. Hãy cho biết khái niệm OOP là gì?</span>
//               </h2>
//             </div>
//             <div>
//               <div className="mb-3 flex items-center">
//                 <input type="radio" name="id__answer--3" />
//                 <span className="ml-2">
//                   A. OOP là object oriented programming.
//                 </span>
//               </div>
//               <div className="mb-3 flex items-center">
//                 <input type="radio" name="id__answer--3" />
//                 <span className="ml-2">
//                   B. OOP là object oriented programming.
//                 </span>
//               </div>
//               <div className="mb-3 flex items-center">
//                 <input type="radio" name="id__answer--3" />
//                 <span className="ml-2">
//                   C. OOP là object oriented programming.
//                 </span>
//               </div>
//               <div className="mb-3 flex items-center">
//                 <input type="radio" name="id__answer--3" />
//                 <span className="ml-2">
//                   D. OOP là object oriented programming.
//                 </span>
//               </div>
//             </div>
//           </div>

//           <div className="mb-6">
//             <div>
//               <h2 className="font-semibold mb-4">
//                 <span>4</span>
//                 <span>. Hãy cho biết khái niệm OOP là gì?</span>
//               </h2>
//             </div>
//             <div>
//               <div className="mb-3 flex items-center">
//                 <input type="radio" name="id__answer--4" />
//                 <span className="ml-2">
//                   A. OOP là object oriented programming.
//                 </span>
//               </div>
//               <div className="mb-3 flex items-center">
//                 <input type="radio" name="id__answer--4" />
//                 <span className="ml-2">
//                   B. OOP là object oriented programming.
//                 </span>
//               </div>
//               <div className="mb-3 flex items-center">
//                 <input type="radio" name="id__answer--4" />
//                 <span className="ml-2">
//                   C. OOP là object oriented programming.
//                 </span>
//               </div>
//               <div className="mb-3 flex items-center">
//                 <input type="radio" name="id__answer--4" />
//                 <span className="ml-2">
//                   D. OOP là object oriented programming.
//                 </span>
//               </div>
//             </div>
//           </div>
//         </div>
//       </div>
//     </div>
//   );
// };

// export default DoTest;

import { useState, useEffect } from "react";
import { useNavigate, useLocation } from "react-router-dom";
import { Clock } from "lucide-react";
import axios from "axios";

const DoTest = () => {
  const navigate = useNavigate();
  const location = useLocation();
  const examData = location.state?.examData; // Dữ liệu bài thi được truyền qua navigation state

  // States
  const [timeLeft, setTimeLeft] = useState(examData?.duration || 2400); // 40 phút mặc định
  const [userAnswers, setUserAnswers] = useState({});
  const [loading, setLoading] = useState(false);

  // Kiểm tra nếu không có dữ liệu bài thi thì quay về trang trước
  // useEffect(() => {
  //   if (!examData) {
  //     navigate(-1);
  //   }
  // }, [examData, navigate]);

  // Format thời gian từ giây sang mm:ss
  const formatTime = (seconds) => {
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = seconds % 60;
    return `${minutes}:${remainingSeconds.toString().padStart(2, "0")}`;
  };

  // Đồng hồ đếm ngược - bắt đầu ngay khi component mount
  useEffect(() => {
    if (timeLeft <= 0) return;

    const timer = setInterval(() => {
      setTimeLeft((prevTime) => {
        if (prevTime <= 1) {
          clearInterval(timer);
          handleSubmit();
          return 0;
        }
        return prevTime - 1;
      });
    }, 1000);

    return () => clearInterval(timer);
  }, [timeLeft]);

  // Xử lý chọn đáp án
  const handleAnswerSelect = (questionId, answer) => {
    setUserAnswers((prev) => ({
      ...prev,
      [questionId]: answer,
    }));
  };

  // Xử lý nộp bài
  const handleSubmit = async () => {
    try {
      setLoading(true);

      const response = await axios.post("your-api-endpoint/submit", {
        examId: examData.id,
        answers: userAnswers,
        timeSpent: examData.duration - timeLeft,
      });

      if (response.status === 200) {
        // Quay về trang trước đó
        navigate(-1);
      }
    } catch (error) {
      console.error("Error submitting exam:", error);
      alert("Có lỗi xảy ra khi nộp bài!");
    } finally {
      setLoading(false);
    }
  };

  // Xử lý báo lỗi
  const handleReportIssue = async () => {
    try {
      const response = await axios.post("your-api-endpoint/report-issue", {
        examId: examData.id,
        timestamp: new Date().toISOString(),
      });

      if (response.status === 200) {
        alert("Đã gửi báo cáo lỗi thành công!");
      }
    } catch (error) {
      console.error("Error reporting issue:", error);
      alert("Có lỗi xảy ra khi báo cáo!");
    }
  };

  if (loading) {
    return (
      <div className="w-full h-full flex items-center justify-center">
        <div>Đang xử lý...</div>
      </div>
    );
  }

  return (
    <div className="w-full h-full max-w-4xl mx-auto mt-8 bg-gray-100 px-10 py-5 font-nunito">
      {/* Header */}
      <div className="flex items-center justify-between mb-8">
        <div>
          <h1 className="text-2xl font-bold mb-4">
            Bài thi môn <span>{examData?.subject}</span>
          </h1>
        </div>
        <div className="flex items-center justify-center">
          <div className="text-blue-600 font-bold mr-12 flex items-center">
            <Clock className="w-5 h-5 mr-2" />
            <span>{formatTime(timeLeft)}</span>
          </div>
          <div className="mr-6">
            <button
              onClick={handleSubmit}
              disabled={loading}
              className="w-28 bg-blue-500 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition duration-300 disabled:opacity-50"
            >
              Nộp bài
            </button>
          </div>
          <div>
            <button
              onClick={handleReportIssue}
              disabled={loading}
              className="w-28 bg-blue-500 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition duration-300 disabled:opacity-50"
            >
              Báo lỗi
            </button>
          </div>
        </div>
      </div>

      {/* Nội dung bài thi */}
      <div className="overflow-x-auto max-h-[500px] bg-white rounded-2xl">
        <div className="px-12 py-6">
          {examData?.questions.map((question, index) => (
            <div key={question.id} className="mb-6">
              <div>
                <h2 className="font-semibold mb-4">
                  <span>{index + 1}</span>
                  <span>. {question.content}</span>
                </h2>
              </div>
              <div>
                {question.options.map((option, optionIndex) => (
                  <div key={optionIndex} className="mb-3 flex items-center">
                    <input
                      type="radio"
                      name={`question-${question.id}`}
                      value={option.id}
                      checked={userAnswers[question.id] === option.id}
                      onChange={() =>
                        handleAnswerSelect(question.id, option.id)
                      }
                      className="cursor-pointer"
                      disabled={loading}
                    />
                    <span className="ml-2">
                      {option.label}. {option.content}
                    </span>
                  </div>
                ))}
              </div>
            </div>
          ))}
        </div>
      </div>
    </div>
  );
};

export default DoTest;
